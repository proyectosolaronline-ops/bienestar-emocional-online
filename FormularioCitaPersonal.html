<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cita Personal ‚Äî Bienestar Emocional</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Jost:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --rosa:#FF85C0; --lila:#A67FFF; --lila-deep:#6B48CC;
    --bg:#FDF8FF; --card:#FFFFFF; --text:#1E1530;
    --muted:#857A9E; --border:#EAE0FF;
  }
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Jost',sans-serif;background:var(--bg);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:32px 16px;overflow-x:hidden}
  body::before{content:'';position:fixed;top:-180px;right:-180px;width:520px;height:520px;border-radius:50%;background:radial-gradient(circle,rgba(255,133,192,.13) 0%,transparent 68%);pointer-events:none}
  body::after{content:'';position:fixed;bottom:-150px;left:-150px;width:460px;height:460px;border-radius:50%;background:radial-gradient(circle,rgba(166,127,255,.11) 0%,transparent 68%);pointer-events:none}
  .card{width:100%;max-width:500px;background:var(--card);border-radius:28px;box-shadow:0 2px 8px rgba(107,72,204,.06),0 16px 56px rgba(107,72,204,.1);overflow:hidden;animation:fadeUp .55s cubic-bezier(.22,.68,0,1.2) both}
  @keyframes fadeUp{from{opacity:0;transform:translateY(28px)}to{opacity:1;transform:translateY(0)}}
  .hdr{background:linear-gradient(145deg,#FF85C0 0%,#C880FF 55%,#A67FFF 100%);padding:36px 36px 48px;position:relative}
  .hdr::after{content:'';position:absolute;bottom:0;left:0;right:0;height:32px;background:var(--card);border-radius:28px 28px 0 0}
  .hdr-ico{width:52px;height:52px;background:rgba(255,255,255,.22);backdrop-filter:blur(6px);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:1.6rem;margin-bottom:16px}
  .hdr h1{font-family:'Cormorant Garamond',serif;color:#fff;font-size:1.9rem;font-weight:700;line-height:1.2}
  .hdr p{color:rgba(255,255,255,.82);font-size:.88rem;margin-top:7px;font-weight:300}
  .body{padding:8px 36px 40px}
  .tipo-wrap{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;margin-bottom:26px}
  .tipo-btn{border:1.5px solid var(--border);border-radius:14px;padding:13px 6px 11px;text-align:center;cursor:pointer;transition:all .22s;background:#fff;display:flex;flex-direction:column;align-items:center;gap:5px}
  .tipo-btn .ico{font-size:1.5rem}
  .tipo-btn .lbl{font-size:.76rem;font-weight:600;color:var(--muted);letter-spacing:.03em;text-transform:uppercase}
  .tipo-btn:hover{border-color:var(--lila);background:#FAF6FF}
  .tipo-btn.sel{border-color:var(--lila);background:linear-gradient(135deg,#FFF0FA,#F3ECFF);box-shadow:0 2px 14px rgba(166,127,255,.2)}
  .tipo-btn.sel .lbl{color:var(--lila-deep)}
  .sec{font-family:'Cormorant Garamond',serif;font-size:1.08rem;font-weight:600;color:var(--lila-deep);margin-bottom:15px;padding-bottom:8px;border-bottom:1px dashed var(--border)}
  .grp{margin-bottom:16px}
  label{display:block;font-size:.76rem;font-weight:600;color:var(--muted);letter-spacing:.06em;text-transform:uppercase;margin-bottom:6px}
  label em{color:var(--rosa);font-style:normal}
  input,select,textarea{width:100%;padding:12px 15px;border:1.5px solid var(--border);border-radius:12px;font-family:'Jost',sans-serif;font-size:.93rem;color:var(--text);background:#fff;outline:none;transition:border .2s,box-shadow .2s;appearance:none}
  input::placeholder,textarea::placeholder{color:#C4B8D8}
  input:focus,select:focus,textarea:focus{border-color:var(--lila);box-shadow:0 0 0 4px rgba(166,127,255,.1)}
  select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='11' height='7'%3E%3Cpath d='M1 1l4.5 4.5L10 1' stroke='%23A67FFF' stroke-width='1.6' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;padding-right:38px;cursor:pointer}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:13px}
  .sep{border:none;border-top:1px dashed var(--border);margin:20px 0}
  .btn{width:100%;margin-top:10px;padding:15px;background:linear-gradient(135deg,var(--rosa),var(--lila));color:#fff;border:none;border-radius:50px;font-family:'Jost',sans-serif;font-size:1rem;font-weight:600;letter-spacing:.04em;cursor:pointer;transition:opacity .2s,transform .18s,box-shadow .2s;box-shadow:0 6px 22px rgba(166,127,255,.32)}
  .btn:hover:not(:disabled){opacity:.93;transform:translateY(-2px)}
  .btn:disabled{opacity:.55;cursor:not-allowed;transform:none;box-shadow:none}
  .fb{display:none;margin-top:16px;padding:14px 18px;border-radius:13px;font-size:.88rem;text-align:center;line-height:1.6}
  .fb.ok{background:#EDFAF4;color:#1B6B42;border:1px solid #9FDFBE}
  .fb.err{background:#FFF0F5;color:#B5294A;border:1px solid #F7AABF}
  .spin{display:inline-block;width:15px;height:15px;border:2px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:7px}
  @keyframes spin{to{transform:rotate(360deg)}}
  @media(max-width:460px){.hdr{padding:26px 20px 40px}.body{padding:6px 20px 30px}.two{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="card">
  <div class="hdr">
    <div class="hdr-ico">üíú</div>
    <h1>Agenda tu Cita</h1>
    <p>Atenci√≥n clara, emp√°tica y sin juicios</p>
  </div>
  <div class="body">
    <form id="form" novalidate>

      <!-- ‚îÄ‚îÄ Col G: Tipo_Paciente ‚îÄ‚îÄ -->
      <p class="sec">¬øPara qui√©n es la cita?</p>
      <input type="hidden" id="Tipo_Paciente" value="">
      <div class="tipo-wrap">
        <div class="tipo-btn" onclick="selTipo(this,'Infantil')">
          <span class="ico">üßí</span><span class="lbl">Infantil</span>
        </div>
        <div class="tipo-btn" onclick="selTipo(this,'Adolescente')">
          <span class="ico">üßë</span><span class="lbl">Adolescente</span>
        </div>
        <div class="tipo-btn" onclick="selTipo(this,'Adulto')">
          <span class="ico">üë§</span><span class="lbl">Adulto</span>
        </div>
      </div>

      <hr class="sep">
      <p class="sec">Datos de contacto</p>

      <!-- Col C: Nombre -->
      <div class="grp">
        <label>Nombre completo <em>*</em></label>
        <input type="text" id="Nombre" placeholder="Tu nombre completo" required>
      </div>

      <div class="two">
        <!-- Col D: Telefono -->
        <div class="grp">
          <label>Tel√©fono <em>*</em></label>
          <input type="tel" id="Telefono" placeholder="10 d√≠gitos" required>
        </div>
        <!-- Col E: Correo -->
        <div class="grp">
          <label>Correo</label>
          <input type="email" id="Correo" placeholder="tu@correo.com">
        </div>
      </div>

      <hr class="sep">
      <p class="sec">Tipo de atenci√≥n</p>

      <!-- Col F: Tipo_Terapia -->
      <div class="grp">
        <label>Servicio que necesitas <em>*</em></label>
        <select id="Tipo_Terapia" required>
          <option value="" disabled selected>Selecciona un servicio‚Ä¶</option>
          <option>Terapia individual</option>
          <option>Evaluaci√≥n psicol√≥gica</option>
          <option>Acompa√±amiento emocional</option>
          <option>Orientaci√≥n a padres</option>
          <option>Terapia de pareja</option>
          <option>Manejo de duelo</option>
          <option>Desarrollo personal</option>
        </select>
      </div>

      <!-- Col A=Timestamp ¬∑ Col B=ID_Paciente ¬∑ Col H=Estado  ‚Üí  generados en servidor -->

      <button type="submit" class="btn" id="btn">Enviar solicitud ‚Üí</button>
      <div class="fb" id="fb"></div>
    </form>
  </div>
</div>

<script>
  // ‚îÄ‚îÄ Precargar datos desde URL (viene de be-welcome) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  (function() {
    var p = new URLSearchParams(window.location.search);
    var map = {
      nombre:   'Nombre',
      telefono: 'Telefono',
      correo:   'Correo'
    };
    Object.keys(map).forEach(function(key) {
      var val = p.get(key);
      var el  = document.getElementById(map[key]);
      if (val && el) {
        el.value = decodeURIComponent(val);
        if (key === 'correo') {
          el.readOnly = true;
          el.style.background = '#FAF6FF';
          el.style.color = '#6B48CC';
          el.style.fontWeight = '500';
          el.style.borderColor = '#EAE0FF';
        }
      }
    });
    // Guardar ID y sesi√≥n como variables globales para el env√≠o
    window.BE_PACIENTE_ID = p.get('id')    || '';
    window.BE_SESION_ID   = p.get('sesion')|| '';
    window.BE_MODAL       = p.get('modal') || 'Cita Personal';
    window.BE_TIPO        = p.get('tipo')  || 'PAC';
  })();

  var PROXY    = 'https://script.google.com/macros/s/AKfycbw33rJe4JWLUnSHYuRuf4x_FW90YKMA-i2PEHXCoJwqYmUcih90NVV9JpUe_i0jrQli/exec';
  var WA_ADMIN = '524425839311'; // n√∫mero admin con c√≥digo pa√≠s // ‚Üê reemplaza con tu URL desplegada

  function selTipo(el, v) {
    document.querySelectorAll('.tipo-btn').forEach(function(b){ b.classList.remove('sel'); });
    el.classList.add('sel');
    document.getElementById('Tipo_Paciente').value = v;
  }

  document.getElementById('form').addEventListener('submit', function(e) {
    e.preventDefault();
    var nombre = document.getElementById('Nombre').value.trim();
    var tel    = document.getElementById('Telefono').value.trim();
    var tipo   = document.getElementById('Tipo_Paciente').value;
    var serv   = document.getElementById('Tipo_Terapia').value;

    if (!nombre || !tel || !serv) return fb('err','‚ö†Ô∏è Completa los campos obligatorios.');
    if (!tipo)                    return fb('err','‚ö†Ô∏è Selecciona el tipo de paciente.');

    setBtn(true);

    // Mapeado exacto a columnas del Sheet:
    // A=Timestamp(svr) | B=ID_Paciente(svr) | C=Nombre | D=Telefono
    // E=Correo | F=Tipo_Terapia | G=Tipo_Paciente | H=Estado(svr)
    var data = {
      nombre:       nombre,
      telefono:     tel,
      correo:       document.getElementById('Correo').value.trim(),
      tipoTerapia:  serv,
      tipoPaciente: tipo,
      pacienteId:   window.BE_PACIENTE_ID || '',
      sesion:       window.BE_SESION_ID   || '',
      modal:        window.BE_MODAL       || 'Cita Personal'
    };

    fetch(PROXY, {
      method:'POST', redirect:'follow',
      headers:{'Content-Type':'text/plain'},
      body: JSON.stringify({ action:'procesarCitaPersonal', data:data })
    })
    .then(function(r){ return r.json(); })
    .then(function(res){
      if (res.ok) {
        fb('ok','‚úÖ ¬°Solicitud enviada! Pronto te contactaremos.<br><small>ID: '+res.id+'</small>');
        notificarWA(data, res.id || '');
        document.getElementById('form').reset();
        document.querySelectorAll('.tipo-btn').forEach(function(b){ b.classList.remove('sel'); });
        document.getElementById('Tipo_Paciente').value='';
      } else {
        fb('err','‚ùå '+(res.error||'Error al enviar. Intenta de nuevo.'));
      }
    })
    .catch(function(){ fb('err','‚ùå Error de conexi√≥n.'); })
    .finally(function(){ setBtn(false); });
  });

  function notificarWA(data, id) {
    var msg = 'üîî *Nueva solicitud de CITA PERSONAL*\n\n'
      + 'ü™™ *ID:* '        + (id || window.BE_PACIENTE_ID || '‚Äî') + '\n'
      + 'üë§ *Nombre:* '    + data.nombre       + '\n'
      + 'üì± *Tel√©fono:* '  + data.telefono     + '\n'
      + (data.correo   ? 'üìß *Correo:* '    + data.correo    + '\n' : '')
      + 'üß† *Servicio:* '  + data.tipoTerapia  + '\n'
      + 'üë• *Paciente:* '  + data.tipoPaciente + '\n'
      + '\n_Registrada autom√°ticamente en el Sheet._';
    window.open('https://wa.me/' + WA_ADMIN + '?text=' + encodeURIComponent(msg), '_blank');
  }

  function fb(tipo, msg) {
    var el = document.getElementById('fb');
    el.className='fb '+tipo; el.innerHTML=msg; el.style.display='block';
    el.scrollIntoView({behavior:'smooth',block:'nearest'});
  }
  function setBtn(loading) {
    var b = document.getElementById('btn');
    b.disabled = loading;
    b.innerHTML = loading ? '<span class="spin"></span>Enviando‚Ä¶' : 'Enviar solicitud ‚Üí';
  }
</script>
</body>
</html>
